<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interviewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .interviewer {
            background: #e3f2fd;
            margin-right: 20%;
        }
        .user {
            background: #f5f5f5;
            margin-left: 20%;
        }
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .start-btn {
            background: #4CAF50;
            color: white;
        }
        .record-btn {
            background: #f44336;
            color: white;
        }
        .record-btn.recording {
            background: #9e9e9e;
        }
        #status {
            text-align: center;
            margin: 10px 0;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div id="chat-messages"></div>
        <div id="status"></div>
        <div class="controls">
            <button id="startInterview" class="start-btn">Start Interview</button>
            <button id="recordAnswer" class="record-btn" disabled>Record Answer</button>
        </div>
    </div>

    <script>
        let sessionId = null;
        let recognition = null;
        let isRecording = false;

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
        }

        const startBtn = document.getElementById('startInterview');
        const recordBtn = document.getElementById('recordAnswer');
        const chatMessages = document.getElementById('chat-messages');
        const statusDiv = document.getElementById('status');

        function addMessage(text, isInterviewer) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isInterviewer ? 'interviewer' : 'user'}`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function startInterview() {
            try {
                const response = await fetch('/api/interview/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                sessionId = data.sessionId;
                
                startBtn.disabled = true;
                recordBtn.disabled = false;
                
                // Add interviewer's greeting
                addMessage("Hello! I'm your AI interviewer today. I'll be asking you a series of questions. Please take your time to answer thoughtfully. When you're ready to respond, click the 'Record Answer' button and speak clearly.", true);
                
                // Add first question with a slight delay to seem more natural
                setTimeout(() => {
                    addMessage(data.question.text, true);
                }, 1000);
            } catch (error) {
                console.error('Error starting interview:', error);
                statusDiv.textContent = 'Error starting interview. Please try again.';
            }
        }

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            if (recognition) {
                let finalTranscript = '';
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    statusDiv.textContent = interimTranscript;
                };

                recognition.onend = async () => {
                    if (isRecording) {
                        isRecording = false;
                        recordBtn.textContent = 'Record Answer';
                        recordBtn.classList.remove('recording');
                        
                        if (finalTranscript) {
                            addMessage(finalTranscript, false);
                            await submitAnswer(finalTranscript);
                        }
                    }
                };

                recognition.start();
                isRecording = true;
                recordBtn.textContent = 'Stop Recording';
                recordBtn.classList.add('recording');
                statusDiv.textContent = 'Listening...';
            }
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
        }

        async function submitAnswer(answer) {
            try {
                const response = await fetch('/api/interview/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId, answer })
                });
                
                const data = await response.json();
                
                if (data.status === 'completed') {
                    addMessage(data.message, true);
                    recordBtn.disabled = true;
                    startBtn.disabled = false;
                } else {
                    // Add a natural pause before next question
                    setTimeout(() => {
                        addMessage(data.question.text, true);
                    }, 1500);
                }
                
                statusDiv.textContent = '';
            } catch (error) {
                console.error('Error submitting answer:', error);
                statusDiv.textContent = 'Error submitting answer. Please try again.';
            }
        }

        startBtn.addEventListener('click', startInterview);
        recordBtn.addEventListener('click', toggleRecording);
    </script>
</body>
</html>